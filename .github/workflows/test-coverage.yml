name: Test Coverage Comparison

on:
  pull_request:
    branches: [ main ]

# Add permissions block to allow commenting on PR
permissions:
  contents: read
  pull-requests: write

jobs:
  coverage-comparison:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate PR coverage
        id: pr-coverage
        run: |
          npm test -- --coverage --watchAll=false > coverage_output.txt
          PR_LINES=$(grep "All files" coverage_output.txt | awk '{print $4}')
          echo "PR_COVERAGE=${PR_LINES%.*}" >> $GITHUB_ENV
          mkdir -p /tmp/pr-coverage
          cp -r coverage /tmp/pr-coverage
      
      - name: Checkout base branch
        run: git checkout ${{ github.event.pull_request.base.sha }}
      
      - name: Install dependencies on base branch
        run: npm ci
      
      - name: Generate base coverage
        id: base-coverage
        run: |
          npm test -- --coverage --watchAll=false > coverage_output.txt
          BASE_LINES=$(grep "All files" coverage_output.txt | awk '{print $4}')
          echo "BASE_COVERAGE=${BASE_LINES%.*}" >> $GITHUB_ENV
      
      - name: Calculate coverage difference
        id: coverage-diff
        run: |
          PR_COV=${{ env.PR_COVERAGE }}
          BASE_COV=${{ env.BASE_COVERAGE }}
          
          # Remove percentage sign if present
          PR_COV=${PR_COV//%/}
          BASE_COV=${BASE_COV//%/}
          
          # Calculate the difference
          DIFF=$(echo "$PR_COV - $BASE_COV" | bc)
          echo "COVERAGE_DIFF=$DIFF" >> $GITHUB_ENV
          
          if (( $(echo "$DIFF >= 0" | bc -l) )); then
            ICON="✅"
          else
            ICON="⚠️"
          fi
          
          echo "ICON=$ICON" >> $GITHUB_ENV
      
      - name: Comment on PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const icon = process.env.ICON;
            const diff = process.env.COVERAGE_DIFF;
            const prCoverage = process.env.PR_COVERAGE;
            const baseCoverage = process.env.BASE_COVERAGE;
            
            const diffString = diff > 0 ? `+${diff}` : diff;
            
            const comment = `## Test Coverage Report ${icon}
            
            | Branch | Coverage |
            | ------ | -------- |
            | Base Branch | ${baseCoverage}% |
            | PR Branch | ${prCoverage}% |
            | Difference | ${diffString}% |
            
            ${diff >= 0 ? '✅ Great job! Test coverage has increased or remained the same.' : '⚠️ Warning: Test coverage has decreased with this PR.'}`
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            }) 